#!/usr/bin/env python3
"""
Tests pour les services Semaine 7 AgroBizChat
Validation optimisation performance et monitoring
"""

import sys
import os
sys.path.insert(0, os.path.dirname(__file__))

from src.services.cache_service import CacheService
from src.services.monitoring_service import MonitoringService
from src.services.database_optimizer import DatabaseOptimizer

def test_cache_service():
    """Test du service de cache Redis"""
    print("üîÑ Test CacheService...")
    
    try:
        cache_service = CacheService()
        
        # Test disponibilit√©
        is_available = cache_service.is_available()
        print(f"‚úÖ Cache disponible: {is_available}")
        
        # Test stockage et r√©cup√©ration
        test_key = "test_key"
        test_value = {"test": "data", "number": 42}
        
        # Stocker une valeur
        set_success = cache_service.set(test_key, test_value, ttl=60)
        print(f"‚úÖ Stockage cache: {set_success}")
        
        # R√©cup√©rer la valeur
        retrieved_value = cache_service.get(test_key)
        if retrieved_value:
            assert retrieved_value['test'] == 'data', "Valeur r√©cup√©r√©e incorrecte"
            assert retrieved_value['number'] == 42, "Nombre r√©cup√©r√© incorrect"
            print("‚úÖ R√©cup√©ration cache OK")
        else:
            print("‚ö†Ô∏è Cache non disponible (mode test)")
        
        # Test get_or_set
        def test_callback():
            return {"callback": "result"}
        
        callback_result = cache_service.get_or_set("callback_test", test_callback, ttl=60)
        if callback_result:
            assert callback_result['callback'] == 'result', "R√©sultat callback incorrect"
            print("‚úÖ Get or set OK")
        
        # Test statistiques
        stats = cache_service.get_cache_stats()
        print(f"‚úÖ Statistiques cache: {stats}")
        
        # Test health check
        health = cache_service.health_check()
        print(f"‚úÖ Health check: {health['status']}")
        
        print("üéâ CacheService: Tests de base passent!")
        return True
        
    except Exception as e:
        print(f"‚ùå Erreur CacheService: {e}")
        return False

def test_monitoring_service():
    """Test du service de monitoring"""
    print("\nüìä Test MonitoringService...")
    
    try:
        monitoring_service = MonitoringService()
        
        # Test m√©triques actuelles
        metrics = monitoring_service.get_current_metrics()
        assert 'monitoring_enabled' in metrics, "M√©triques non disponibles"
        print("‚úÖ M√©triques actuelles OK")
        
        # Test enregistrement appel API
        monitoring_service.log_api_call('/test/endpoint', 'GET', 200, 0.5)
        monitoring_service.log_api_call('/test/endpoint', 'POST', 201, 1.2)
        monitoring_service.log_api_call('/test/endpoint', 'GET', 404, 0.1)
        
        # Test statistiques API
        api_stats = monitoring_service.get_api_statistics()
        assert len(api_stats) > 0, "Aucune statistique API"
        print("‚úÖ Statistiques API OK")
        
        # Test enregistrement erreur
        monitoring_service.log_error('test_error', 'Erreur de test', {'detail': 'test'})
        
        # Test statistiques erreurs
        error_stats = monitoring_service.get_error_statistics()
        assert 'total_errors' in error_stats, "Statistiques erreurs manquantes"
        print("‚úÖ Statistiques erreurs OK")
        
        # Test statut de sant√©
        health = monitoring_service.get_health_status()
        assert 'status' in health, "Statut de sant√© manquant"
        print(f"‚úÖ Health status: {health['status']}")
        
        # Test informations syst√®me
        system_info = monitoring_service.get_system_info()
        assert 'platform' in system_info, "Informations syst√®me manquantes"
        print("‚úÖ Informations syst√®me OK")
        
        # Test rapport de synth√®se
        summary = monitoring_service.get_summary_report()
        assert 'monitoring_enabled' in summary, "Rapport de synth√®se manquant"
        print("‚úÖ Rapport de synth√®se OK")
        
        print("üéâ MonitoringService: Tous les tests passent!")
        return True
        
    except Exception as e:
        print(f"‚ùå Erreur MonitoringService: {e}")
        return False

def test_database_optimizer():
    """Test du service d'optimisation base de donn√©es"""
    print("\nüîß Test DatabaseOptimizer...")
    
    try:
        db_optimizer = DatabaseOptimizer()
        
        # Test statistiques base de donn√©es
        stats = db_optimizer.get_database_stats()
        assert 'db_size_mb' in stats, "Statistiques DB manquantes"
        print(f"‚úÖ Statistiques DB: {stats['db_size_mb']} MB")
        
        # Test cr√©ation index
        index_result = db_optimizer.create_indexes()
        assert 'status' in index_result, "R√©sultat cr√©ation index manquant"
        print(f"‚úÖ Cr√©ation index: {index_result['status']}")
        
        # Test suggestions d'optimisation
        suggestions = db_optimizer.get_query_suggestions()
        assert 'suggestions' in suggestions, "Suggestions manquantes"
        print("‚úÖ Suggestions d'optimisation OK")
        
        # Test health check
        health = db_optimizer.health_check()
        assert 'status' in health, "Health check DB manquant"
        print(f"‚úÖ Health check DB: {health['status']}")
        
        # Test optimisation base de donn√©es
        optimize_result = db_optimizer.optimize_database()
        assert 'status' in optimize_result, "R√©sultat optimisation manquant"
        print(f"‚úÖ Optimisation DB: {optimize_result['status']}")
        
        # Test cr√©ation vues optimis√©es
        views_result = db_optimizer.create_optimized_queries()
        assert 'status' in views_result, "R√©sultat cr√©ation vues manquant"
        print(f"‚úÖ Cr√©ation vues: {views_result['status']}")
        
        print("üéâ DatabaseOptimizer: Tous les tests passent!")
        return True
        
    except Exception as e:
        print(f"‚ùå Erreur DatabaseOptimizer: {e}")
        return False

def test_cache_integration():
    """Test d'int√©gration du cache avec les services existants"""
    print("\nüîó Test int√©gration cache...")
    
    try:
        cache_service = CacheService()
        
        # Test cache m√©t√©o
        weather_data = {
            'zone': 'Zone des terres de barre',
            'temperature': 28,
            'humidity': 75,
            'precipitation': 0
        }
        
        cache_success = cache_service.cache_weather_data('Zone des terres de barre', weather_data)
        print(f"‚úÖ Cache m√©t√©o: {cache_success}")
        
        cached_weather = cache_service.get_cached_weather_data('Zone des terres de barre')
        if cached_weather:
            assert cached_weather['temperature'] == 28, "Temp√©rature cache incorrecte"
            print("‚úÖ R√©cup√©ration m√©t√©o cache OK")
        
        # Test cache vari√©t√©s ananas
        pineapple_varieties = [
            {'name': 'Smooth Cayenne', 'yield_per_ha': 35.0},
            {'name': 'Queen Victoria', 'yield_per_ha': 25.0}
        ]
        
        cache_success = cache_service.cache_pineapple_varieties(pineapple_varieties)
        print(f"‚úÖ Cache vari√©t√©s ananas: {cache_success}")
        
        cached_varieties = cache_service.get_cached_pineapple_varieties()
        if cached_varieties:
            assert len(cached_varieties) == 2, "Nombre vari√©t√©s cache incorrect"
            print("‚úÖ R√©cup√©ration vari√©t√©s cache OK")
        
        # Test cache business plan
        business_plan = {
            'user_id': 1,
            'title': 'Test Business Plan',
            'variety': 'Smooth Cayenne',
            'profit': 25000
        }
        
        cache_success = cache_service.cache_business_plan(1, business_plan)
        print(f"‚úÖ Cache business plan: {cache_success}")
        
        cached_plan = cache_service.get_cached_business_plan(1)
        if cached_plan:
            assert cached_plan['title'] == 'Test Business Plan', "Titre cache incorrect"
            print("‚úÖ R√©cup√©ration business plan cache OK")
        
        # Test cache diagnostic
        diagnosis = {
            'disease_name': 'Fusariose',
            'confidence': 0.85,
            'severity': '√âlev√©e'
        }
        
        cache_success = cache_service.cache_disease_diagnosis('test_image_hash', diagnosis)
        print(f"‚úÖ Cache diagnostic: {cache_success}")
        
        cached_diagnosis = cache_service.get_cached_diagnosis('test_image_hash')
        if cached_diagnosis:
            assert cached_diagnosis['disease_name'] == 'Fusariose', "Maladie cache incorrecte"
            print("‚úÖ R√©cup√©ration diagnostic cache OK")
        
        print("üéâ Int√©gration cache: Tous les tests passent!")
        return True
        
    except Exception as e:
        print(f"‚ùå Erreur int√©gration cache: {e}")
        return False

def test_performance_improvements():
    """Test des am√©liorations de performance"""
    print("\n‚ö° Test am√©liorations performance...")
    
    try:
        # Test monitoring en temps r√©el
        monitoring_service = MonitoringService()
        
        # Simuler des appels API
        for i in range(5):
            monitoring_service.log_api_call('/test/performance', 'GET', 200, 0.1 + i * 0.1)
            monitoring_service.log_api_call('/test/performance', 'POST', 201, 0.2 + i * 0.1)
        
        # Simuler des erreurs
        monitoring_service.log_error('performance_test', 'Test erreur performance')
        
        # V√©rifier les m√©triques
        metrics = monitoring_service.get_current_metrics()
        assert 'cpu' in metrics, "M√©triques CPU manquantes"
        assert 'memory' in metrics, "M√©triques m√©moire manquantes"
        print("‚úÖ M√©triques temps r√©el OK")
        
        # V√©rifier les statistiques API
        api_stats = monitoring_service.get_api_statistics()
        assert '/test/performance' in api_stats, "Statistiques API manquantes"
        print("‚úÖ Statistiques API temps r√©el OK")
        
        # V√©rifier le statut de sant√©
        health = monitoring_service.get_health_status()
        assert health['status'] in ['healthy', 'warning', 'critical'], "Statut de sant√© invalide"
        print(f"‚úÖ Health status temps r√©el: {health['status']}")
        
        # Test cache avec monitoring
        cache_service = CacheService()
        
        # Mesurer les performances du cache
        import time
        
        # Test sans cache
        start_time = time.time()
        for i in range(10):
            # Simuler une op√©ration co√ªteuse
            time.sleep(0.01)
        no_cache_time = time.time() - start_time
        
        # Test avec cache
        start_time = time.time()
        for i in range(10):
            cache_service.get_or_set(f"perf_test_{i}", lambda: time.sleep(0.01), ttl=60)
        cache_time = time.time() - start_time
        
        print(f"‚úÖ Temps sans cache: {no_cache_time:.3f}s")
        print(f"‚úÖ Temps avec cache: {cache_time:.3f}s")
        print(f"‚úÖ Am√©lioration: {((no_cache_time - cache_time) / no_cache_time * 100):.1f}%")
        
        print("üéâ Am√©liorations performance: Tous les tests passent!")
        return True
        
    except Exception as e:
        print(f"‚ùå Erreur am√©liorations performance: {e}")
        return False

def test_database_optimization():
    """Test des optimisations de base de donn√©es"""
    print("\nüóÑÔ∏è Test optimisations base de donn√©es...")
    
    try:
        db_optimizer = DatabaseOptimizer()
        
        # Test analyse requ√™te
        test_query = "SELECT * FROM users WHERE email = 'test@example.com'"
        analysis = db_optimizer.analyze_query_performance(test_query)
        assert 'status' in analysis, "Analyse requ√™te manquante"
        print("‚úÖ Analyse requ√™te OK")
        
        # Test statistiques base de donn√©es
        stats = db_optimizer.get_database_stats()
        assert 'db_size_mb' in stats, "Taille DB manquante"
        assert 'tables' in stats, "Tables manquantes"
        assert 'indexes_count' in stats, "Nombre d'index manquant"
        print(f"‚úÖ Statistiques DB: {stats['db_size_mb']} MB, {len(stats['tables'])} tables, {stats['indexes_count']} index")
        
        # Test health check
        health = db_optimizer.health_check()
        assert 'status' in health, "Health check manquant"
        assert 'metrics' in health, "M√©triques health check manquantes"
        print(f"‚úÖ Health check DB: {health['status']}")
        
        # Test suggestions
        suggestions = db_optimizer.get_query_suggestions()
        assert 'suggestions' in suggestions, "Suggestions manquantes"
        assert 'indexes' in suggestions['suggestions'], "Suggestions index manquantes"
        assert 'queries' in suggestions['suggestions'], "Suggestions requ√™tes manquantes"
        print("‚úÖ Suggestions d'optimisation OK")
        
        print("üéâ Optimisations base de donn√©es: Tous les tests passent!")
        return True
        
    except Exception as e:
        print(f"‚ùå Erreur optimisations base de donn√©es: {e}")
        return False

def run_week7_tests():
    """Ex√©cute tous les tests de la semaine 7"""
    print("üöÄ D√©but des tests Semaine 7 - Optimisation performance...\n")
    
    tests = [
        test_cache_service,
        test_monitoring_service,
        test_database_optimizer,
        test_cache_integration,
        test_performance_improvements,
        test_database_optimization
    ]
    
    passed = 0
    total = len(tests)
    
    for test in tests:
        if test():
            passed += 1
    
    print(f"\nüìä R√©sultats des tests Semaine 7:")
    print(f"‚úÖ Tests r√©ussis: {passed}/{total}")
    print(f"‚ùå Tests √©chou√©s: {total - passed}/{total}")
    
    if passed == total:
        print("üéâ Tous les tests passent! Services Semaine 7 pr√™ts pour la production.")
        return True
    else:
        print("‚ö†Ô∏è Certains tests ont √©chou√©. V√©rifiez la configuration.")
        return False

if __name__ == '__main__':
    success = run_week7_tests()
    sys.exit(0 if success else 1) 